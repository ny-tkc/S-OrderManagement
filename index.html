<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ソフトウェア受注管理ツール</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone@7.12.15/babel.min.js"></script>
    <script type="importmap">
      {
        "imports": {
          "react": "https://aistudiocdn.com/react@^19.1.1",
          "react-dom/": "https://aistudiocdn.com/react-dom@^19.1.1/",
          "react/": "https://aistudiocdn.com/react@^19.1.1/",
          "uuid": "https://aistudiocdn.com/uuid@^13.0.0",
          "recharts": "https://aistudiocdn.com/recharts@^2.12.7"
        }
      }
    </script>
    <style>
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      .modal-content {
        background-color: white;
        padding: 2rem;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        width: 90%;
        max-width: 1152px; /* Increased width further */
      }
      .filter-panel {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out;
        padding-top: 0;
        padding-bottom: 0;
      }
      .filter-panel.visible {
        max-height: 500px; /* Adjust as needed */
        padding-top: 1rem;
        padding-bottom: 1rem;
      }
      .achievement-stamp {
        position: absolute;
        top: 0.5rem; /* 8px */
        right: 0.5rem; /* 8px */
        transform: rotate(15deg);
        font-size: 1.5rem; /* Reduced font size */
        font-weight: bold;
        color: red;
        border: 4px solid red; /* Adjusted border */
        border-radius: 5px;
        padding: 0.1rem 0.5rem;
        opacity: 0.8;
        pointer-events: none;
        z-index: 10;
      }
      .rainbow-text {
        background-image: linear-gradient(45deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3);
        background-size: 200% 200%;
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        animation: rainbow-animation 3s ease infinite;
      }
      @keyframes rainbow-animation {
        0%{background-position:0% 50%}
        50%{background-position:100% 50%}
        100%{background-position:0% 50%}
      }
      /* Column Resizing Styles */
      .resizable-table th {
        position: relative;
      }
       /* Add a visible separator line to indicate resizability */
      .resizable-table th:not(:last-child)::after {
        content: '';
        position: absolute;
        top: 25%;
        right: 0;
        height: 50%;
        width: 1px;
        background-color: #d1d5db; /* gray-300 */
      }
      .resizer {
        position: absolute;
        top: 0;
        right: -4px; /* Center the grab area on the line */
        width: 9px;
        cursor: col-resize;
        user-select: none;
        height: 100%;
        z-index: 10;
      }
      .resizer:hover, .resizing {
        background-color: rgba(165, 180, 252, 0.5); /* Semi-transparent indigo for better visibility */
      }
      /* Button Pulse Animation */
      .btn-pulse {
          animation: pulse-animation 2s infinite;
      }
      @keyframes pulse-animation {
          0% { box-shadow: 0 0 0 0 rgba(96, 165, 250, 0.7); }
          70% { box-shadow: 0 0 0 10px rgba(96, 165, 250, 0); }
          100% { box-shadow: 0 0 0 0 rgba(96, 165, 250, 0); }
      }
      /* For Recharts */
      .recharts-responsive-container {
        min-height: 400px;
      }
       /* Prose styles for info modals */
      .prose h3 { font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem; margin-top: 1.5rem; }
      .prose p { margin-bottom: 1rem; line-height: 1.6; }
      .prose ul { list-style-type: disc; margin-left: 1.5rem; margin-bottom: 1rem; }
      .prose li { margin-bottom: 0.5rem; }
      .prose strong { font-weight: 600; }
      .prose code { background-color: #e5e7eb; padding: 0.2rem 0.4rem; border-radius: 0.25rem; font-size: 0.9em; }
    </style>
<link rel="stylesheet" href="/index.css">
</head>
  <body class="bg-gray-100">
    <div id="root"></div>
    <script type="text/babel" data-type="module">
      import React, { useState, useEffect, useMemo, useCallback, useRef } from 'react';
      import ReactDOM from 'react-dom/client';
      import { v4 as uuidv4 } from 'uuid';

      // --- Constants and Services ---
      
      function useLocalStorage(key, initialValue) {
        const [storedValue, setStoredValue] = useState(() => {
          try {
            const item = window.localStorage.getItem(key);
            return item ? JSON.parse(item) : initialValue;
          } catch (error) {
            console.error(error);
            return initialValue;
          }
        });

        const setValue = (value) => {
          try {
            const valueToStore = value instanceof Function ? value(storedValue) : value;
            setStoredValue(valueToStore);
            window.localStorage.setItem(key, JSON.stringify(valueToStore));
          } catch (error) {
            console.error(error);
          }
        };

        return [storedValue, setValue];
      }

      const generateFiscalPeriods = () => {
        const periods = [];
        const baseYearForTermCalc = 2024; // 第59期の開始年

        for (let term = 59; term <= 65; term++) {
          const startYearOfTerm = baseYearForTermCalc + (term - 59);

          // 上期: 10月1日〜翌年3月31日
          const firstHalfStart = new Date(startYearOfTerm, 9, 1);
          const firstHalfEnd = new Date(startYearOfTerm + 1, 2, 31);
          periods.push({
            id: `${term}-1`,
            name: `第${term}期 上期`,
            startDate: firstHalfStart,
            endDate: firstHalfEnd,
          });

          // 下期: 4月1日〜9月30日
          const secondHalfStart = new Date(startYearOfTerm + 1, 3, 1);
          const secondHalfEnd = new Date(startYearOfTerm + 1, 8, 30);
          periods.push({
            id: `${term}-2`,
            name: `第${term}期 下期`,
            startDate: secondHalfStart,
            endDate: secondHalfEnd,
          });
        }
        return periods;
      };

      const getCurrentPeriod = (periods) => {
        const now = new Date();
        return periods.find(p => now >= new Date(p.startDate) && now <= new Date(p.endDate));
      };

      const parsePastedData = (text, selectedPeriod, existingItems = [], dataType = 'orders') => {
          // Normalize line endings and filter out empty lines.
          const lines = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n').split('\n').filter(line => line.trim() !== '');
          const newItems = [];
          const errors = [];
          const warnings = []; // Add warnings array
          if (lines.length === 0) return { newItems, errors, warnings, };
          
          const delimiter = lines[0].includes('\t') ? '\t' : (lines[0].includes(',') ? ',' : ' ');

          let dataLines = lines;
          let headerSkipped = false;

          // Header detection
          if (lines.length > 0) {
              const firstLineParts = lines[0].split(delimiter);
              if (firstLineParts.length > 1 && !/^\d{8}$/.test(firstLineParts[1].replace(/"/g, '').trim())) {
                  dataLines = lines.slice(1);
                  headerSkipped = true;
              }
          }

          dataLines.forEach((line, index) => {
              const originalLineNumber = index + 1 + (headerSkipped ? 1 : 0);
              try {
                  const parts = delimiter === ' ' ? line.split(/\s+/).filter(Boolean) : line.split(delimiter);
                  
                  const dateRaw = parts[1].replace(/"/g, '').trim();
                  if (!/^\d{8}$/.test(dateRaw)) {
                      throw new Error('日付の形式が不正です (必須形式: YYYYMMDD)。');
                  }
                  const orderDate = `${dateRaw.substring(0, 4)}-${dateRaw.substring(4, 6)}-${dateRaw.substring(6, 8)}`;
                  
                  const orderDateObj = new Date(orderDate);
                   if (isNaN(orderDateObj.getTime())) {
                      throw new Error('日付が無効です。');
                  }
                  orderDateObj.setHours(0, 0, 0, 0);
                  const periodStartDate = new Date(selectedPeriod.startDate);
                  periodStartDate.setHours(0,0,0,0);
                  const periodEndDate = new Date(selectedPeriod.endDate);
                  periodEndDate.setHours(0,0,0,0);

                  if (orderDateObj < periodStartDate || orderDateObj > periodEndDate) {
                      throw new Error(`受注日は選択された期間（${selectedPeriod.name}）内に設定してください。`);
                  }
                  
                  if (dataType === 'orders') {
                      if (parts.length < 7) throw new Error('列の数が不足しています。');
                      const officeCode = parts[2].replace(/"/g, '').trim();
                      const officeName = parts[3].replace(/"/g, '').trim();
                      const clientCode = parts[4].replace(/"/g, '').trim();
                      const clientName = parts[5].replace(/"/g, '').trim();
                      let system = parts[6].replace(/"/g, '').trim();

                      if (!officeCode || !officeName || !clientCode || !clientName || !system) {
                          throw new Error('必須項目（事務所コード, 事務所名, 分類コード, 関与先名, システム）が空です。');
                      }
                      
                      system = system.replace(/[\s　]*(関与先)?(セットアップライセンス|ｾｯﾄｱｯﾌﾟﾗｲｾﾝｽ)/g, '').trim();
                      
                      newItems.push({ id: uuidv4(), periodId: selectedPeriod.id, orderDate, officeCode, officeName, clientCode, clientName, system, isTransferred: false });
                  } else if (dataType === 'cancellations') {
                      if (parts.length < 8) throw new Error('列の数が不足しています。必要な列は8列以上です。');
                      const officeCode = parts[3].replace(/"/g, '').trim();
                      const officeName = parts[4].replace(/"/g, '').trim();
                      const clientCode = parts[5].replace(/"/g, '').trim();
                      const clientName = parts[6].replace(/"/g, '').trim();
                      const system = parts[7].replace(/"/g, '').trim();
                      const cancellationReason = parts.length > 9 ? parts[9].replace(/"/g, '').trim() : '';

                      if (!officeCode || !officeName || !clientCode || !clientName || !system) {
                          throw new Error('必須項目（事務所コード, 事務所名, 分類コード, 関与先名, システム）が空です。');
                      }
                      
                      newItems.push({ id: uuidv4(), periodId: selectedPeriod.id, orderDate, officeCode, officeName, clientCode, clientName, system, cancellationReason, isTransferred: false });
                  } else { // 'migrations'
                      if (parts.length < 11) throw new Error('列の数が不足しています。');
                      const officeCode = parts[3].replace(/"/g, '').trim();
                      const officeName = parts[4].replace(/"/g, '').trim();
                      const clientCode = parts[5].replace(/"/g, '').trim();
                      const clientName = parts[6].replace(/"/g, '').trim();
                      const beforeSystem = parts[9].replace(/"/g, '').trim();
                      const afterSystem = parts[10].replace(/"/g, '').trim();

                      if (!officeCode || !officeName || !clientCode || !clientName || !beforeSystem || !afterSystem) {
                          throw new Error('必須項目（事務所コード, 事務所名, 分類コード, 関与先名, 変更前/後システム）が空です。');
                      }
                      
                      // NOTE: Warning generation is disabled during parsing as per user request.
                      // It will be handled by the post-registration alert system.
                      // if (beforeSystem.includes('クラウド') || beforeSystem.includes('ｸﾗｳﾄﾞ')) {
                      //     warnings.push(`行 ${originalLineNumber}: 変更前システム「${beforeSystem}」に「クラウド」が含まれています。これはクラウド移行の対象ではない可能性があります。`);
                      // }
                      
                      newItems.push({ id: uuidv4(), periodId: selectedPeriod.id, orderDate, officeCode, officeName, clientCode, clientName, beforeSystem, afterSystem });
                  }
              } catch (error) {
                  errors.push(`行 ${originalLineNumber}: ${error.message} - "${line}"`);
              }
          });
          return { newItems, errors, warnings };
      };


      // --- Components ---

      const SummaryCard = ({ title, value, suffix, color, subValue, isAchieved, compact = false }) => (
        <div 
          className={`bg-white ${compact ? 'p-3' : 'p-6'} rounded-lg shadow-md flex flex-col justify-center items-center text-center relative h-full`}
        >
          {isAchieved && <div className="achievement-stamp">達成</div>}
          <h3 className={`text-gray-500 ${compact ? 'text-sm' : 'text-lg'} font-semibold mb-2`}>{title}</h3>
          <div>
            <p className={`${compact ? 'text-3xl' : 'text-5xl'} font-bold ${color}`}>
              {value}
              {suffix && <span className={`${compact ? 'text-lg' : 'text-2xl'} ml-1`}>{suffix}</span>}
            </p>
            {subValue && <p className={`${compact ? 'text-xs' : 'text-sm'} text-gray-500 mt-1`}>{subValue}</p>}
          </div>
        </div>
      );
      
      const EditableSummaryCard = ({ title, value, suffix, color, onSave, subValue, editInitialValue, compact = false }) => {
        const [isEditing, setIsEditing] = useState(false);
        const [editValue, setEditValue] = useState(editInitialValue !== undefined ? editInitialValue : value);
        const inputRef = useRef(null);

        useEffect(() => {
            setEditValue(editInitialValue !== undefined ? editInitialValue : value);
        }, [value, editInitialValue]);
        
        useEffect(() => {
            if (isEditing) {
                inputRef.current?.focus();
                inputRef.current?.select();
            }
        }, [isEditing]);

        const handleSave = () => {
            if (!window.confirm(`「${title}」を${editValue}件に設定します。よろしいですか？`)) {
                return;
            }
            const newValue = parseInt(editValue, 10);
            if (!isNaN(newValue)) { // Allow negative numbers for adjustment
                onSave(newValue);
            } else {
                setEditValue(editInitialValue !== undefined ? editInitialValue : value); // Revert if invalid
            }
            setIsEditing(false);
        };
        
        const handleCancel = () => {
          setEditValue(editInitialValue !== undefined ? editInitialValue : value);
          setIsEditing(false);
        };

        const handleKeyDown = (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                handleSave();
            } else if (e.key === 'Escape') {
                handleCancel();
            }
        };
        
        if (isEditing) {
          return (
             <div className={`bg-white ${compact ? 'p-3' : 'p-6'} rounded-lg shadow-md flex flex-col justify-between h-full ring-2 ring-indigo-400`}>
                  <h3 className={`text-gray-500 ${compact ? 'text-sm' : 'text-lg'} font-semibold text-center`}>{title}</h3>
                  <div>
                      <input
                          ref={inputRef}
                          type="number"
                          value={editValue}
                          onChange={(e) => setEditValue(e.target.value)}
                          onKeyDown={handleKeyDown}
                          className={`${compact ? 'text-3xl' : 'text-5xl'} font-bold w-full bg-transparent border-b-2 border-indigo-300 focus:outline-none ${color} mb-2 text-center`}
                      />
                      <div className="flex justify-end space-x-2 mt-2">
                          <button onClick={handleCancel} className="text-xs px-2 py-1 rounded bg-gray-200 hover:bg-gray-300 text-gray-700">中止</button>
                          <button onClick={handleSave} className="text-xs px-2 py-1 rounded bg-indigo-600 hover:bg-indigo-700 text-white">保存</button>
                      </div>
                  </div>
              </div>
          );
        }

        return (
            <div 
                className={`bg-white ${compact ? 'p-3' : 'p-6'} rounded-lg shadow-md flex flex-col justify-center items-center text-center h-full cursor-pointer hover:shadow-lg hover:ring-2 hover:ring-indigo-400 transition relative`}
                onClick={() => setIsEditing(true)}
            >
                <div className={`absolute ${compact ? 'top-3 right-3' : 'top-4 right-4'}`}>
                     <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z" /></svg>
                </div>
                <h3 className={`text-gray-500 ${compact ? 'text-sm' : 'text-lg'} font-semibold mb-2`}>{title}</h3>
                <div>
                    <p className={`${compact ? 'text-3xl' : 'text-5xl'} font-bold ${color}`}>
                        {value}
                        {suffix && <span className={`${compact ? 'text-lg' : 'text-2xl'} ml-1`}>{suffix}</span>}
                    </p>
                    {subValue && <p className={`${compact ? 'text-xs' : 'text-sm'} text-gray-500 mt-1`}>{subValue}</p>}
                </div>
            </div>
        );
      };

      const DetailsView = ({ items, offices, systems, onDeleteItem, onToggleTransfer, viewType }) => {
        const [filterText, setFilterText] = useState('');
        const [filterOffice, setFilterOffice] = useState('');
        const [filterSystem, setFilterSystem] = useState('');
        const [filterStartDate, setFilterStartDate] = useState('');
        const [filterEndDate, setFilterEndDate] = useState('');
        const [sortConfig, setSortConfig] = useState({ key: 'orderDate', direction: 'descending' });
        const [filtersVisible, setFiltersVisible] = useState(false);
        const [colWidths, setColWidths] = useLocalStorage(`colWidths-${viewType}`, 
            viewType === 'orders'
                ? { orderDate: 120, officeCode: 250, clientCode: 120, clientName: 250, system: 250, actions: 120 }
                : viewType === 'cancellations'
                ? { orderDate: 120, officeCode: 200, clientCode: 100, clientName: 200, system: 200, cancellationReason: 250, actions: 120 }
                : { orderDate: 120, officeCode: 250, clientCode: 120, clientName: 250, beforeSystem: 250, afterSystem: 250, actions: 80 }
        );
        const tableRef = useRef(null);
        const isResizing = useRef(null);

        const handleMouseDown = useCallback((e, key) => {
            isResizing.current = {
                key,
                startX: e.clientX,
                startWidth: colWidths[key],
            };
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
        }, [colWidths]);
        
        const handleMouseMove = useCallback((e) => {
            if (!isResizing.current) return;
            const { key, startX, startWidth } = isResizing.current;
            const newWidth = startWidth + (e.clientX - startX);
            if (newWidth > 50) {
                 setColWidths(prev => ({...prev, [key]: newWidth}));
            }
        }, []);

        const handleMouseUp = useCallback(() => {
            isResizing.current = null;
            document.removeEventListener('mousemove', handleMouseMove);
            document.removeEventListener('mouseup', handleMouseUp);
        }, []);

        const requestSort = (key) => {
            let direction = 'ascending';
            if (sortConfig.key === key && sortConfig.direction === 'ascending') {
                direction = 'descending';
            }
            setSortConfig({ key, direction });
        };
        
        const sortedAndFilteredItems = useMemo(() => {
            let filtered = [...items];
            
            if (filterText) {
                const lowerFilterText = filterText.toLowerCase();
                filtered = filtered.filter(order => 
                    order.clientName.toLowerCase().includes(lowerFilterText) ||
                    (order.clientCode && order.clientCode.toLowerCase().includes(lowerFilterText))
                );
            }
            if(filterOffice){
                filtered = filtered.filter(order => order.officeCode === filterOffice);
            }
            if(filterSystem){
                filtered = filtered.filter(order => order.system === filterSystem);
            }
            if(filterStartDate){
                filtered = filtered.filter(order => new Date(order.orderDate) >= new Date(filterStartDate));
            }
            if(filterEndDate){
                 filtered = filtered.filter(order => new Date(order.orderDate) <= new Date(filterEndDate));
            }

            filtered.sort((a, b) => {
                let valA = a[sortConfig.key];
                let valB = b[sortConfig.key];
                
                if (sortConfig.key === 'officeCode') {
                    valA = a.officeName || '';
                    valB = b.officeName || '';
                }

                if (valA < valB) {
                    return sortConfig.direction === 'ascending' ? -1 : 1;
                }
                if (valA > valB) {
                    return sortConfig.direction === 'ascending' ? 1 : -1;
                }
                return 0;
            });

            return filtered;

        }, [items, filterText, filterOffice, filterSystem, filterStartDate, filterEndDate, sortConfig]);

        const ResizableHeader = ({ label, columnKey, width }) => {
          const isActive = sortConfig.key === columnKey;
          const icon = sortConfig.direction === 'ascending' ? '▲' : '▼';
          return (
            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" style={{width: `${width}px`}}>
                <div className="flex items-center cursor-pointer" onClick={() => requestSort(columnKey)}>
                    {label}
                    {isActive && <span className="ml-2">{icon}</span>}
                </div>
              <div className="resizer" onMouseDown={(e) => handleMouseDown(e, columnKey)} />
            </th>
          );
        };
        
        const resetFilters = () => {
          setFilterText(''); 
          setFilterOffice(''); 
          setFilterSystem('');
          setFilterStartDate(''); 
          setFilterEndDate('');
        };

        const WarningIcon = ({ title }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-yellow-500 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor" title={title}>
              <path fillRule="evenodd" d="M8.257 3.099c.636-1.1 2.046-1.1 2.682 0l5.98 10.356c.636 1.1-.069 2.475-1.341 2.475H3.618c-1.272 0-1.977-1.375-1.341-2.475L8.257 3.099zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-4a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z" clipRule="evenodd" />
            </svg>
        );

        return (
             <div className="space-y-4">
                <div className="bg-white p-6 rounded-lg shadow-md">
                    <button onClick={() => setFiltersVisible(!filtersVisible)} className="flex items-center justify-between w-full text-left font-semibold text-gray-700 mb-2">
                        <span>{filtersVisible ? 'フィルターを隠す' : 'フィルターを表示'}</span>
                        <svg className={`w-5 h-5 transform transition-transform ${filtersVisible ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div className={`filter-panel ${filtersVisible ? 'visible' : ''}`}>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 items-center">
                            <input
                                type="text"
                                placeholder="関与先名、コードで検索..."
                                value={filterText}
                                onChange={(e) => setFilterText(e.target.value)}
                                className="border rounded px-4 py-2"
                            />
                             <select value={filterOffice} onChange={e => setFilterOffice(e.target.value)} className="border rounded px-4 py-2">
                                <option value="">すべての事務所</option>
                                {offices.map(o => <option key={o.code} value={o.code}>{o.name}</option>)}
                            </select>
                             <select value={filterSystem} onChange={e => setFilterSystem(e.target.value)} className="border rounded px-4 py-2" disabled={viewType === 'migrations'}>
                                <option value="">すべてのシステム</option>
                                {systems.map(s => <option key={s} value={s}>{s}</option>)}
                            </select>
                            <div className="flex items-center gap-x-2 md:col-span-2">
                                <input type="date" value={filterStartDate} onChange={e => setFilterStartDate(e.target.value)} className="border rounded px-4 py-2 w-full" />
                                <span className="text-gray-500">～</span>
                                <input type="date" value={filterEndDate} onChange={e => setFilterEndDate(e.target.value)} className="border rounded px-4 py-2 w-full" />
                            </div>
                            <button onClick={resetFilters} className="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded md:col-start-3">
                                リセット
                            </button>
                        </div>
                    </div>
                </div>
                <div className="bg-white rounded-lg shadow-md">
                    <div className="overflow-x-auto">
                        <table ref={tableRef} className="w-full divide-y divide-gray-200 resizable-table" style={{tableLayout: 'fixed'}}>
                        <thead className="bg-gray-50">
                            {viewType === 'orders' || viewType === 'cancellations' ? (
                                <tr>
                                   <ResizableHeader label={viewType === 'cancellations' ? "解約日" : "受注日"} columnKey="orderDate" width={colWidths.orderDate} />
                                   <ResizableHeader label="事務所" columnKey="officeCode" width={colWidths.officeCode} />
                                   <ResizableHeader label={<span>分類<br/>コード</span>} columnKey="clientCode" width={colWidths.clientCode} />
                                   <ResizableHeader label="関与先名" columnKey="clientName" width={colWidths.clientName} />
                                   <ResizableHeader label="システム" columnKey="system" width={colWidths.system} />
                                   {viewType === 'cancellations' && <ResizableHeader label="解約理由" columnKey="cancellationReason" width={colWidths.cancellationReason} />}
                                   <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider sticky right-0 bg-gray-50 z-20 border-l border-gray-200" style={{width: `${colWidths.actions}px`}}>操作</th>
                                </tr>
                            ) : (
                                <tr>
                                   <ResizableHeader label="移行日" columnKey="orderDate" width={colWidths.orderDate} />
                                   <ResizableHeader label="事務所" columnKey="officeCode" width={colWidths.officeCode} />
                                   <ResizableHeader label={<span>分類<br/>コード</span>} columnKey="clientCode" width={colWidths.clientCode} />
                                   <ResizableHeader label="関与先名" columnKey="clientName" width={colWidths.clientName} />
                                   <ResizableHeader label="変更前" columnKey="beforeSystem" width={colWidths.beforeSystem} />
                                   <ResizableHeader label="変更後" columnKey="afterSystem" width={colWidths.afterSystem} />
                                   <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider sticky right-0 bg-gray-50 z-20 border-l border-gray-200" style={{width: `${colWidths.actions}px`}}>操作</th>
                                </tr>
                            )}
                        </thead>
                        <tbody className="bg-white divide-y divide-gray-200">
                            {sortedAndFilteredItems.map(item => (
                                <tr key={item.id} className={viewType === 'orders' && item.isTransferred ? 'bg-gray-200 text-gray-500' : ''}>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900 truncate">{item.orderDate}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 truncate">{item.officeName} ({item.officeCode})</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 truncate">{item.clientCode}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 truncate">{item.clientName}</td>
                                    {viewType === 'orders' || viewType === 'cancellations' ? (
                                        <>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 truncate">{item.system}</td>
                                            {viewType === 'cancellations' && <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 truncate" title={item.cancellationReason}>{item.cancellationReason}</td>}
                                        </>
                                    ) : (
                                        <>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 truncate">
                                                <div className="flex items-center">
                                                    {(item.beforeSystem.includes('クラウド') || item.beforeSystem.includes('ｸﾗｳﾄﾞ')) && (
                                                      <WarningIcon title="変更前システムに「クラウド」が含まれているため、移行対象ではない可能性があります。" />
                                                    )}
                                                    <span className="ml-1 truncate">{item.beforeSystem}</span>
                                                </div>
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 truncate">{item.afterSystem}</td>
                                        </>
                                    )}
                                    <td className="px-6 py-4 whitespace-nowrap text-center text-sm font-medium sticky right-0 bg-white border-l border-gray-200">
                                       {viewType === 'orders' && (
                                            <>
                                                <button onClick={() => {
                                                    const message = item.isTransferred
                                                        ? '事務所移管を取り消し、集計対象に戻しますか？'
                                                        : '事務所移管として集計結果から除外しますか？';
                                                    if (window.confirm(message)) {
                                                        onToggleTransfer(item.id);
                                                    }
                                                }} className={`mr-2 ${item.isTransferred ? 'text-gray-500 hover:text-gray-700' : 'text-blue-600 hover:text-blue-900'}`}>{item.isTransferred ? '解除' : '移管'}</button>
                                                <button onClick={() => {
                                                    if(window.confirm(`「${item.clientName}」のデータを削除しますか？`)) { 
                                                        onDeleteItem(item.id) 
                                                    }
                                                }} className="text-red-600 hover:text-red-900 ml-2">
                                                    削除
                                                </button>
                                            </>
                                        )}
                                        {viewType === 'migrations' && (
                                            <button onClick={() => {
                                                if(window.confirm(`「${item.clientName}」のデータを削除しますか？`)) { 
                                                    onDeleteItem(item.id) 
                                                }
                                            }} className="text-red-600 hover:text-red-900">
                                                削除
                                            </button>
                                        )}
                                        {viewType === 'cancellations' && (
                                            <button onClick={() => {
                                                if(window.confirm(`「${item.clientName}」の解約データを削除しますか？`)) { 
                                                    onDeleteItem(item.id) 
                                                }
                                            }} className="text-red-600 hover:text-red-900">
                                                削除
                                            </button>
                                        )}
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                        </table>
                        {sortedAndFilteredItems.length === 0 && (
                          <p className="text-center text-gray-500 py-8">該当するデータはありません。</p>
                        )}
                    </div>
                </div>
            </div>
        )
      };

      const DataEntryModal = ({ selectedPeriod, onAddOrders, onAddMigrations, onAddCancellations, onClose, ordersForPeriod, migrationsForPeriod, cancellationsForPeriod }) => {
        const [activeTab, setActiveTab] = useState('orders');
        const [orderText, setOrderText] = useState('');
        const [migrationText, setMigrationText] = useState('');
        const [cancellationText, setCancellationText] = useState('');
        const [result, setResult] = useState(null);

        const handleSubmit = (e) => {
            e.preventDefault();
            let text, existingItems, onAdd, dataType;

            switch(activeTab) {
              case 'orders':
                text = orderText;
                existingItems = ordersForPeriod;
                onAdd = onAddOrders;
                dataType = 'orders';
                break;
              case 'migrations':
                text = migrationText;
                existingItems = migrationsForPeriod;
                onAdd = onAddMigrations;
                dataType = 'migrations';
                break;
              case 'cancellations':
                text = cancellationText;
                existingItems = cancellationsForPeriod;
                onAdd = onAddCancellations;
                dataType = 'cancellations';
                break;
              default:
                return;
            }

            if (!text.trim()) return;

            const {newItems, errors, warnings} = parsePastedData(text, selectedPeriod, existingItems, dataType);

            if (newItems.length > 0) {
                onAdd(newItems);
            }
            
            setResult({ success: newItems.length, failed: errors.length, warnings: warnings.length, errors, warnings });
            if (newItems.length > 0 && errors.length === 0) {
                 if(activeTab === 'orders') setOrderText('');
                 else if (activeTab === 'migrations') setMigrationText('');
                 else if (activeTab === 'cancellations') setCancellationText('');
            }
        };

        return (
            <div className="modal-overlay" onClick={onClose}>
                <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-2xl font-bold text-gray-800">データ一括登録</h2>
                        <button onClick={onClose} className="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
                    </div>
                     <div className="border-b border-gray-200 mb-4">
                        <nav className="-mb-px flex space-x-6">
                           <button onClick={() => setActiveTab('orders')} className={`px-4 py-2 text-sm font-medium rounded-t-lg transition-colors border-b-2 ${activeTab === 'orders' ? 'border-indigo-600 text-indigo-600' : 'border-transparent text-gray-600 hover:border-gray-300'}`}>受注データ</button>
                           <button onClick={() => setActiveTab('migrations')} className={`px-4 py-2 text-sm font-medium rounded-t-lg transition-colors border-b-2 ${activeTab === 'migrations' ? 'border-indigo-600 text-indigo-600' : 'border-transparent text-gray-600 hover:border-gray-300'}`}>クラウド移行データ</button>
                           <button onClick={() => setActiveTab('cancellations')} className={`px-4 py-2 text-sm font-medium rounded-t-lg transition-colors border-b-2 ${activeTab === 'cancellations' ? 'border-indigo-600 text-indigo-600' : 'border-transparent text-gray-600 hover:border-gray-300'}`}>解約データ</button>
                        </nav>
                    </div>

                    <p className="text-sm text-gray-600 mb-2">ＳＦＡの売り上げ速報画面でコピーしたテキストを貼り付け</p>
                    <p className="text-sm text-gray-600 mb-4">各データは改行して入力してください。</p>
                    
                    <form onSubmit={handleSubmit}>
                        {activeTab === 'orders' && (
                            <textarea
                                value={orderText}
                                onChange={(e) => setOrderText(e.target.value)}
                                className="w-full h-48 p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 font-mono text-sm"
                                placeholder="受注データを貼り付け..."
                            />
                        )}
                        {activeTab === 'migrations' && (
                            <textarea
                                value={migrationText}
                                onChange={(e) => setMigrationText(e.target.value)}
                                className="w-full h-48 p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 font-mono text-sm"
                                placeholder="クラウド移行データを貼り付け..."
                            />
                        )}
                        {activeTab === 'cancellations' && (
                          <textarea
                              value={cancellationText}
                              onChange={(e) => setCancellationText(e.target.value)}
                              className="w-full h-48 p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 font-mono text-sm"
                              placeholder="解約データを貼り付け..."
                          />
                        )}
                        <button type="submit" className="w-full mt-4 flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            登録する
                        </button>
                    </form>

                    {result && (
                        <div className="mt-6 p-4 border rounded bg-gray-50">
                            <h4 className="font-semibold text-lg mb-2">登録結果</h4>
                            <p className="text-green-600 font-medium">{result.success}件の登録に成功しました。</p>
                            {result.warnings > 0 && (
                                <>
                                    <p className="text-yellow-600 font-medium mt-2">{result.warnings}件の警告があります。</p>
                                    <ul className="text-sm text-yellow-700 list-disc list-inside max-h-32 overflow-y-auto mt-2 space-y-1 bg-yellow-50 p-2 rounded">
                                        {result.warnings.map((warn, i) => <li key={i}>{warn}</li>)}
                                    </ul>
                                </>
                            )}
                            {result.failed > 0 && (
                                <>
                                    <p className="text-red-600 font-medium mt-2">{result.failed}件の登録に失敗しました。</p>
                                    <ul className="text-sm text-red-700 list-disc list-inside max-h-32 overflow-y-auto mt-2 space-y-1 bg-red-50 p-2 rounded">
                                        {result.errors.map((err, i) => <li key={i}>{err}</li>)}
                                    </ul>
                                </>
                            )}
                        </div>
                    )}
                </div>
            </div>
        );
      };

      const CorrectionModal = ({ issue, onCorrect, onClose }) => {
        if (!issue) return null;

        const { type, data, title, description, correctionLabel } = issue;
        
        let itemsToDisplay = [];
        const groupedDuplicateTypes = ['orderDuplicates', 'migrationDuplicates', 'cancellationDuplicates'];
        
        if (groupedDuplicateTypes.includes(type)) {
            itemsToDisplay = data.flatMap(group => group.items);
        } else {
            itemsToDisplay = data;
        }

        return (
            <div className="modal-overlay" onClick={onClose}>
                <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                    <div className="flex justify-between items-start mb-4">
                        <div>
                           <h2 className="text-2xl font-bold text-red-600">{title}</h2>
                           <p className="text-gray-600 mt-1">{description}</p>
                        </div>
                        <button onClick={onClose} className="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
                    </div>
                    
                    <div className="max-h-80 overflow-y-auto border rounded p-4 bg-gray-50 mb-6">
                        <h3 className="font-semibold mb-2">対象データ ({itemsToDisplay.length}件)</h3>
                        <ul className="divide-y divide-gray-200">
                            {itemsToDisplay.map(item => (
                                <li key={item.id} className="py-2 text-sm">
                                    <span className="font-medium">{item.clientName}</span> ({item.orderDate})
                                    <span className="text-gray-500 ml-2">
                                        {item.system ? item.system : `${item.beforeSystem} → ${item.afterSystem}`}
                                    </span>
                                </li>
                            ))}
                        </ul>
                    </div>

                    <div className="flex justify-end space-x-4">
                        <button onClick={onClose} className="px-6 py-2 rounded-md text-gray-700 bg-gray-200 hover:bg-gray-300">
                            キャンセル
                        </button>
                        <button onClick={() => { if(window.confirm(`${correctionLabel}を実行します。この操作は元に戻せません。よろしいですか？`)) onCorrect(type); }} className="px-6 py-2 rounded-md text-white bg-red-600 hover:bg-red-700">
                            {correctionLabel}
                        </button>
                    </div>
                </div>
            </div>
        );
      };
      
      const InfoModal = ({ title, onClose, children }) => (
        <div className="modal-overlay" onClick={onClose}>
            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                <div className="flex justify-between items-center mb-4 border-b pb-3">
                    <h2 className="text-2xl font-bold text-gray-800">{title}</h2>
                    <button onClick={onClose} className="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
                </div>
                <div className="prose max-w-none text-gray-700 max-h-[70vh] overflow-y-auto pr-4">
                    {children}
                </div>
                 <div className="flex justify-end mt-6 border-t pt-4">
                    <button onClick={onClose} className="px-6 py-2 rounded-md text-white bg-indigo-600 hover:bg-indigo-700">
                        閉じる
                    </button>
                </div>
            </div>
        </div>
      );

      const App = () => {
        const fiscalPeriods = useMemo(() => generateFiscalPeriods(), []);
        const initialPeriod = getCurrentPeriod(fiscalPeriods) || fiscalPeriods[0];
        
        const [view, setView] = useState('orders'); // 'orders' | 'migrations' | 'cancellations'
        const [activeSubView, setActiveSubView] = useState('details'); // 'details' | 'analysis'
        const [selectedPeriodId, setSelectedPeriodId] = useState(initialPeriod.id);
        
        const [orders, setOrders] = useLocalStorage('orders', []);
        const [migrations, setMigrations] = useLocalStorage('migrations', []);
        const [cancellations, setCancellations] = useLocalStorage('cancellations', []);
        const [orderTargets, setOrderTargets] = useLocalStorage('allTargets', {});
        const [migrationSettings, setMigrationSettings] = useLocalStorage('migrationSettings', {});

        const fileInputRef = useRef(null);

        const [isDataEntryModalOpen, setDataEntryModalOpen] = useState(false);
        const [isCorrectionModalOpen, setCorrectionModalOpen] = useState(false);
        const [activeCorrectionIssue, setActiveCorrectionIssue] = useState(null);
        const [isGuideModalOpen, setGuideModalOpen] = useState(false);
        const [isCalcInfoModalOpen, setCalcInfoModalOpen] = useState(false);
        
        useEffect(() => {
          const currentPeriod = getCurrentPeriod(fiscalPeriods);
          if (currentPeriod) {
            setSelectedPeriodId(currentPeriod.id);
          }
        }, [fiscalPeriods]);

        // --- View-dependent state and handlers ---
        const isOrdersView = view === 'orders';
        const isMigrationsView = view === 'migrations';
        const isCancellationsView = view === 'cancellations';

        const currentItems = isOrdersView ? orders : isMigrationsView ? migrations : cancellations;
        const setCurrentItems = isOrdersView ? setOrders : isMigrationsView ? setMigrations : setCancellations;
        
        const selectedPeriod = fiscalPeriods.find(p => p.id === selectedPeriodId) || initialPeriod;

        const itemsForPeriod = useMemo(() => currentItems.filter(o => o.periodId === selectedPeriod.id), [currentItems, selectedPeriod.id]);
        const ordersForPeriod = useMemo(() => orders.filter(o => o.periodId === selectedPeriod.id), [orders, selectedPeriod.id]);
        const migrationsForPeriod = useMemo(() => migrations.filter(o => o.periodId === selectedPeriod.id), [migrations, selectedPeriod.id]);
        const cancellationsForPeriod = useMemo(() => cancellations.filter(c => c.periodId === selectedPeriod.id), [cancellations, selectedPeriod.id]);
        
        const handleAddItems = (newItems, setItems) => {
            setItems(prevItems => [...prevItems, ...newItems]);
        };

        const handleDeleteItem = (itemId) => {
          setCurrentItems(prevItems => prevItems.filter(item => item.id !== itemId));
        };
        
        const handleToggleTransfer = (orderId) => {
            setOrders(prevOrders => 
                prevOrders.map(order => 
                    order.id === orderId 
                    ? { ...order, isTransferred: !order.isTransferred } 
                    : order 
                )
            );
        };
        
        const handleSaveOrderTarget = (newTarget) => {
          setOrderTargets(prev => ({ ...prev, [selectedPeriod.id]: newTarget }));
        };

        const handleUpdateMigrationSetting = (key, value) => {
            setMigrationSettings(prev => {
                const currentSettings = prev[selectedPeriod.id] || { initialCount: 0, cancellationAdjustment: 0, target: 0 };
                return {
                    ...prev,
                    [selectedPeriod.id]: {
                        ...currentSettings,
                        [key]: value
                    }
                };
            });
        };
        
        // --- Data Validation Logic ---
        const validationIssues = useMemo(() => {
            const findDuplicates = (items, getKey) => {
                const groups = items.reduce((acc, item) => {
                    const key = getKey(item);
                    if (!acc[key]) acc[key] = [];
                    acc[key].push(item);
                    return acc;
                }, {});
                return Object.values(groups)
                    .filter(group => group.length > 1)
                    .map(items => ({ key: getKey(items[0]), items }));
            };

            const itemKey = o => `${o.orderDate}|${o.officeCode}|${o.clientCode || ''}|${o.clientName}|${o.system}`;
            const orderDuplicates = findDuplicates(orders, itemKey);
            const cancellationDuplicates = findDuplicates(cancellations, itemKey);

            const migrationKey = m => `${m.orderDate}|${m.officeCode}|${m.clientCode || ''}|${m.clientName}|${m.beforeSystem}|${m.afterSystem}`;
            const migrationDuplicates = findDuplicates(migrations, migrationKey);

            const migrationMistakes = migrations.filter(m => m.beforeSystem.includes('クラウド') || m.beforeSystem.includes('ｸﾗｳﾄﾞ'));

            const migrationKeySet = new Set(migrations.map(m => `${m.orderDate}|${m.clientName}`));
            const crossDuplicates = orders.filter(o => 
                !o.isTransferred &&
                migrationKeySet.has(`${o.orderDate}|${o.clientName}`)
            );

            return { orderDuplicates, migrationDuplicates, migrationMistakes, cancellationDuplicates, crossDuplicates };
        }, [orders, migrations, cancellations]);

        const handleShowCorrectionModal = (issueType) => {
            const issueMap = {
                crossDuplicates: { type: 'crossDuplicates', data: validationIssues.crossDuplicates, title: "新規自計化・クラウド移行の重複", description: "以下の新規自計化データは、同じ関与先・日付でクラウド移行データとしても登録されています。クラウド移行が正しい場合、補正を実行するとこれらの新規自計化データが削除されます。", correctionLabel: "新規自計化データを削除" },
                orderDuplicates: { type: 'orderDuplicates', data: validationIssues.orderDuplicates, title: "新規自計化の重複データ", description: "以下のデータが完全に重複して登録されています。補正を実行すると、重複分が統合（1件に集約）されます。", correctionLabel: "重複データを統合" },
                migrationMistakes: { type: 'migrationMistakes', data: validationIssues.migrationMistakes, title: "クラウド移行の登録ミス", description: "変更前システムに「クラウド」が含まれているため、移行対象ではない可能性があります。補正を実行すると、これらのデータは削除されます。", correctionLabel: "対象データを削除" },
                migrationDuplicates: { type: 'migrationDuplicates', data: validationIssues.migrationDuplicates, title: "クラウド移行の重複データ", description: "以下のデータが完全に重複して登録されています。補正を実行すると、重複分が統合（1件に集約）されます。", correctionLabel: "重複データを統合" },
                cancellationDuplicates: { type: 'cancellationDuplicates', data: validationIssues.cancellationDuplicates, title: "解約データの重複", description: "以下のデータが完全に重複して登録されています。補正を実行すると、重複分が統合（1件に集約）されます。", correctionLabel: "重複データを統合" }
            };
            setActiveCorrectionIssue(issueMap[issueType]);
            setCorrectionModalOpen(true);
        };
        
        const handleCorrectIssues = (issueType) => {
          if (issueType === 'orderDuplicates') {
              const idsToRemove = new Set(validationIssues.orderDuplicates.flatMap(group => group.items.slice(1).map(item => item.id)));
              setOrders(prev => prev.filter(item => !idsToRemove.has(item.id)));
          } else if (issueType === 'migrationMistakes') {
              const idsToRemove = new Set(validationIssues.migrationMistakes.map(item => item.id));
              setMigrations(prev => prev.filter(item => !idsToRemove.has(item.id)));
          } else if (issueType === 'migrationDuplicates') {
              const idsToRemove = new Set(validationIssues.migrationDuplicates.flatMap(group => group.items.slice(1).map(item => item.id)));
              setMigrations(prev => prev.filter(item => !idsToRemove.has(item.id)));
          } else if (issueType === 'cancellationDuplicates') {
              const idsToRemove = new Set(validationIssues.cancellationDuplicates.flatMap(group => group.items.slice(1).map(item => item.id)));
              setCancellations(prev => prev.filter(item => !idsToRemove.has(item.id)));
          } else if (issueType === 'crossDuplicates') {
              const idsToRemove = new Set(validationIssues.crossDuplicates.map(item => item.id));
              setOrders(prev => prev.filter(item => !idsToRemove.has(item.id)));
          }
          setCorrectionModalOpen(false);
          setActiveCorrectionIssue(null);
          alert('補正が完了しました。');
        };

        const handleImportClick = () => { fileInputRef.current.click(); };
        
        const handleExportClick = useCallback(() => {
          if (itemsForPeriod.length === 0) {
              alert('エクスポートするデータがありません。');
              return;
          }
          const headers = ['項番', '受注日', '事務所コード', '事務所名', '分類コード', '関与先名', 'システム', '数量', '備考', '完了'];
          const tsvRows = itemsForPeriod.map((o, index) => {
              const systemName = `${o.system} 関与先セットアップライセンス`;
              const date = isCancellationsView ? o.orderDate.replace(/-/g, '') : o.orderDate.replace(/-/g, '');
              const rowData = [
                  index + 1, date, o.officeCode, o.officeName, o.clientCode || '',
                  o.clientName, systemName, '1', '', '○'
              ];
              return rowData.join('\t');
          });
          const tsvContent = [headers.join('\t'), ...tsvRows].join('\n');
          const blob = new Blob([`\uFEFF${tsvContent}`], { type: 'text/tab-separated-values;charset=utf-8;' });
          const link = document.createElement('a');
          const url = URL.createObjectURL(blob);
          link.setAttribute('href', url);
          
          let fileName = 'データ';
          if (isOrdersView) fileName = '受注データ';
          else if (isMigrationsView) fileName = 'クラウド移行データ';
          else if (isCancellationsView) fileName = '解約データ';
          
          link.setAttribute('download', `${fileName}_${selectedPeriod.name}.tsv`);
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }, [itemsForPeriod, selectedPeriod, isOrdersView, isMigrationsView, isCancellationsView]);
        
        const handleFileChange = (event) => {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
              try {
                const buffer = e.target.result; if (!(buffer instanceof ArrayBuffer)) { alert('ファイルの読み込みに失敗しました。'); return; }
                const bytes = new Uint8Array(buffer);
                let encoding = 'shift-jis'; 
                if (bytes.length >= 3 && bytes[0] === 0xEF && bytes[1] === 0xBB && bytes[2] === 0xBF) { encoding = 'utf-8'; }
                const decoder = new TextDecoder(encoding); const text = decoder.decode(buffer);
                if (typeof text !== 'string' || text.trim() === '') { alert('ファイルが空か、読み込みに失敗しました。'); return; }
                
                const dataType = isOrdersView ? 'orders' : isMigrationsView ? 'migrations' : 'cancellations';
                
                const { newItems, errors } = parsePastedData(text, selectedPeriod, [], dataType);
                
                if (newItems.length === 0) {
                    let errorMessage = 'ファイルから登録できる有効なデータが見つかりませんでした。';
                    if (errors.length > 0) { errorMessage += `\n\n検出されたエラー:\n${errors.slice(0, 5).join('\n')}` + (errors.length > 5 ? `\n...他 ${errors.length - 5}件のエラー` : ''); }
                    alert(errorMessage); return;
                }
                let confirmMessage = `${selectedPeriod.name}の既存データ（${itemsForPeriod.length}件）を削除し、ファイルから読み込んだ有効なデータ（${newItems.length}件）で上書きしますか？\n\nこの操作は元に戻せません。`;
                if (errors.length > 0) { confirmMessage += `\n\n警告: ファイル内の ${errors.length}件のデータにエラーがあり、これらは取り込まれません。続行しますか？`; }
                if (window.confirm(confirmMessage)) {
                    setCurrentItems(prevItems => [...prevItems.filter(o => o.periodId !== selectedPeriod.id), ...newItems]);
                    let resultMessage = `${newItems.length}件のデータを登録しました。`;
                    if (errors.length > 0) { resultMessage += `\n${errors.length}件のエラーは無視されました。`; console.error("CSV import errors:", errors); }
                    alert(resultMessage);
                }
              } catch (err) { console.error("An unexpected error occurred during file processing:", err); alert("ファイルの処理中に予期せぬエラーが発生しました。"); }
            };
            reader.onerror = () => { alert(`ファイルの読み込みに失敗しました: ${reader.error}`); };
            reader.readAsArrayBuffer(file);
            event.target.value = null;
        };

        const uniqueOfficesForPeriod = useMemo(() => {
            const officeMap = new Map();
            itemsForPeriod.forEach(order => { if (!officeMap.has(order.officeCode) && order.officeName) officeMap.set(order.officeCode, { code: order.officeCode, name: order.officeName }); });
            return Array.from(officeMap.values()).sort((a, b) => a.code.localeCompare(b.code));
        }, [itemsForPeriod]);

        const uniqueSystemsForPeriod = useMemo(() => [...new Set(itemsForPeriod.map(o => o.system))].sort(), [itemsForPeriod]);

        // --- Summary Card Calculations (Orders View) ---
        const activeOrdersForPeriod = useMemo(() => ordersForPeriod.filter(o => !o.isTransferred), [ordersForPeriod]);
        const transferredOrdersCount = ordersForPeriod.length - activeOrdersForPeriod.length;
        const orderCountSubValue = transferredOrdersCount > 0 ? `(内 移管: ${transferredOrdersCount}件)` : null;
        const totalOrderTarget = orderTargets[selectedPeriod.id] || 0;
        const totalActiveOrders = activeOrdersForPeriod.length;
        const remainingOrders = Math.max(0, totalOrderTarget - totalActiveOrders);
        const orderAchievementRate = totalOrderTarget > 0 ? ((totalActiveOrders / totalOrderTarget) * 100).toFixed(1) : '0.0';
        const isOrderTargetAchieved = parseFloat(orderAchievementRate) >= 100;

        // --- Summary Card Calculations (Migrations View) ---
        const allCloudOrdersForPeriod = useMemo(() => orders.filter(o => o.periodId === selectedPeriod.id && (o.system.includes('クラウド') || o.system.includes('ｸﾗｳﾄﾞ'))), [orders, selectedPeriod.id]);
        const transferredCloudOrdersCount = allCloudOrdersForPeriod.filter(o => o.isTransferred).length;
        const currentMigrationSettings = migrationSettings[selectedPeriod.id] || { initialCount: 0, cancellationAdjustment: 0, target: 0 };
        const migrationTarget = currentMigrationSettings.target;
        const initialCount = currentMigrationSettings.initialCount;
        const cancellationAdjustment = currentMigrationSettings.cancellationAdjustment;
        
        const registeredCloudCancellations = useMemo(() => 
            cancellationsForPeriod.filter(c => c.system.includes('クラウド') || c.system.includes('ｸﾗｳﾄﾞ')),
            [cancellationsForPeriod]
        );
        const registeredCloudCancellationCount = registeredCloudCancellations.length;
        const totalCancellations = registeredCloudCancellationCount + cancellationAdjustment;

        const migrationsThisPeriod = migrationsForPeriod.length;
        const newCloudOrders = allCloudOrdersForPeriod.length;
        const currentMigrationTotal = initialCount + migrationsThisPeriod + newCloudOrders - totalCancellations;
        const remainingMigrations = Math.max(0, migrationTarget - currentMigrationTotal);
        const migrationAchievementRate = migrationTarget > 0 ? ((currentMigrationTotal / migrationTarget) * 100).toFixed(1) : '0.0';
        const isMigrationTargetAchieved = parseFloat(migrationAchievementRate) >= 100;
        const newCloudOrdersSubValue = transferredCloudOrdersCount > 0 ? `(内 移管: ${transferredCloudOrdersCount}件)` : null;
        const cancellationSubValue = `(登録[クラウドのみ]: ${registeredCloudCancellationCount}件 / 手動: ${cancellationAdjustment}件)`;

        const ViewToggleButton = ({ viewName, label }) => (
            <button onClick={() => setView(viewName)} className={`px-6 py-2 text-lg font-semibold rounded-md transition-all duration-200 ease-in-out ${view === viewName ? 'bg-indigo-600 text-white shadow-lg' : 'bg-white text-gray-700 hover:bg-indigo-50'}`}>
                {label}
            </button>
        );

        return (
          <div className="min-h-screen bg-gray-100 text-gray-800">
            {isDataEntryModalOpen && <DataEntryModal selectedPeriod={selectedPeriod} onAddOrders={(newItems) => handleAddItems(newItems, setOrders)} onAddMigrations={(newItems) => handleAddItems(newItems, setMigrations)} onAddCancellations={(newItems) => handleAddItems(newItems, setCancellations)} onClose={() => setDataEntryModalOpen(false)} ordersForPeriod={ordersForPeriod} migrationsForPeriod={migrationsForPeriod} cancellationsForPeriod={cancellationsForPeriod} />}
            {isCorrectionModalOpen && <CorrectionModal issue={activeCorrectionIssue} onCorrect={handleCorrectIssues} onClose={() => setCorrectionModalOpen(false)} />}
            {isGuideModalOpen && (
                <InfoModal title="使い方ガイド" onClose={() => setGuideModalOpen(false)}>
                   <div>
                      <h3>1. 基本的な使い方</h3>
                      <p>このツールは、期間ごとの受注状況を管理・可視化します。上部のメニューで「新規自計化」「クラウド移行」「解約」の表示を切り替えられます。</p>
                      
                      <h3>2. データ登録</h3>
                      <ul>
                        <li><strong>新規登録:</strong> 右上の「新規登録」ボタンから、受注、クラウド移行、解約データを一括で貼り付けて登録できます。</li>
                        <li><strong>データ形式:</strong> SFAの売上速報画面からコピーしたTSV（タブ区切り）形式のテキストを想定しています。ヘッダー行は自動でスキップされます。</li>
                        <li><strong>登録タブ:</strong> 登録したいデータの種類に応じて、「受注データ」「クラウド移行データ」「解約データ」のタブを切り替えてください。</li>
                      </ul>

                      <h3>3. データ補正 (アラート機能)</h3>
                      <p>データ登録後、システムが自動で内容をチェックします。問題が見つかった場合、画面上部にアラートが表示されます。</p>
                      <ul>
                        <li><strong>新規自計化・クラウド移行の重複:</strong> 同じ関与先・日付で「新規自計化」と「クラウド移行」の両方にデータが存在する場合に警告します。クラウドへの移行が正しい場合、補正機能で重複している「新規自計化」データを一括削除できます。</li>
                        <li><strong>重複データ:</strong> 各データ（新規自計化、クラウド移行、解約）内で、同じ内容のデータが複数登録されている場合に表示されます。「詳細表示 & 補正」ボタンから重複データを1つに統合できます。</li>
                        <li><strong>登録ミス:</strong> クラウド移行データで、変更前のシステムに「クラウド」が含まれている場合に表示されます。これらは移行対象ではない可能性が高いため、補正機能で一括削除できます。</li>
                      </ul>

                      <h3>4. ダッシュボードの見方</h3>
                      <ul>
                        <li><strong>目標設定:</strong> 「目標数」などの編集可能な項目は、クリックすることで数値を直接変更できます。</li>
                        <li><strong>クラウド移行の計算:</strong> 純増数は <code>期首累計 + 当期移行 + 新規受注 - 解約</code> で計算されます。右側の「？」アイコンで詳細な計算ロジックを確認できます。</li>
                        <li><strong>達成率:</strong> 目標に対する現在の達成率です。100%を超えると虹色で祝福されます。</li>
                      </ul>
                      
                      <h3>5. 詳細データ一覧</h3>
                      <ul>
                        <li><strong>フィルター:</strong> 「フィルターを表示」ボタンから、関与先名、事務所、システム、期間でデータを絞り込めます。</li>
                        <li><strong>ソート:</strong> 各列のヘッダーをクリックすると、データを昇順・降順で並べ替えられます。</li>
                        <li><strong>列幅調整:</strong> 列の境界線をドラッグすることで、見やすい幅に調整できます。この設定はブラウザに記憶されます。</li>
                        <li><strong>移管:</strong> 「新規自計化」データ一覧の「移管」ボタンを押すと、その受注を集計から除外できます。除外されたデータはグレーで表示され、「解除」ボタンで元に戻せます。</li>
                        <li><strong>解約理由:</strong> 「解約」データ一覧に、SFAから取り込んだ解約理由が表示されるようになりました。</li>
                      </ul>

                      <h3>6. CSV取込・切出</h3>
                      <ul>
                        <li><strong>CSV切出 (エクスポート):</strong> 現在表示されている期間・内容のデータをTSV形式のファイルとしてダウンロードします。</li>
                        <li><strong>CSV取込 (インポート):</strong> 既存のデータをファイルで一括上書き登録します。<strong>注意:</strong> 現在選択中の期間のデータは全て削除され、ファイルの内容に置き換わります。</li>
                      </ul>
                   </div>
                </InfoModal>
            )}
            {isCalcInfoModalOpen && (
                 <InfoModal title="クラウド移行 計算ロジック" onClose={() => setCalcInfoModalOpen(false)}>
                    <div>
                        <p>当期のクラウド純増数は、以下の計算式で算出されています。</p>
                        <p className="text-center font-bold text-lg bg-gray-100 p-4 rounded-md my-4">
                           <code>期首累計</code> + <code>当期移行</code> + <code>新規受注</code> - <code>解約</code>
                        </p>
                        <h3>各項目の詳細</h3>
                        <ul>
                            <li><strong>期首累計:</strong> 前期からの繰り越し件数です。クリックして手動で設定できます。</li>
                            <li><strong>当期移行:</strong> 当期に「クラウド移行データ」として登録された件数です。</li>
                            <li><strong>新規受注:</strong> 当期に「受注データ」として登録された<strong>クラウドシステム</strong>の件数です。<br/><strong>※事務所移管として集計から除外されたデータもこの件数に含まれます。</strong></li>
                            <li><strong>解約:</strong> 当期の解約件数です。以下の合計値となります。
                                <ul>
                                    <li>「解約データ」として登録された<strong>クラウドシステム</strong>の件数。</li>
                                    <li>手動で調整した件数（カードをクリックして編集可能）。</li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                </InfoModal>
            )}
            <input type="file" ref={fileInputRef} onChange={handleFileChange} style={{ display: 'none' }} accept=".csv,.txt,.tsv" />
            
            <header className="bg-white shadow-sm sticky top-0 z-30">
              <div className="container mx-auto px-4 sm:px-6 lg:px-8">
                  <div className="flex items-center justify-between h-16">
                    <div className="flex-1 flex items-center">
                        <h1 className="text-2xl font-bold text-gray-900">ソフトウェア受注管理ツール</h1>
                        <button onClick={() => setGuideModalOpen(true)} className="ml-3 text-gray-400 hover:text-indigo-600" title="使い方ガイド">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                                <path strokeLinecap="round" strokeLinejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </button>
                    </div>
                    <div className="flex-1 flex justify-center items-center">
                       <label htmlFor="period-select" className="text-sm font-medium text-gray-700 mr-2 hidden sm:block">対象期間:</label>
                       <select id="period-select" value={selectedPeriodId} onChange={(e) => setSelectedPeriodId(e.target.value)} className="block pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                        {fiscalPeriods.map(p => ( <option key={p.id} value={p.id}>{p.name}</option>))}
                      </select>
                    </div>
                    <div className="flex-1 flex justify-end items-center space-x-2">
                       <button onClick={handleExportClick} className="px-4 py-2 text-sm font-medium rounded-md text-gray-700 bg-gray-200 hover:bg-gray-300">CSV切出</button>
                       <button onClick={handleImportClick} className="px-4 py-2 text-sm font-medium rounded-md text-indigo-600 bg-indigo-100 hover:bg-indigo-200">CSV取込</button>
                      <button onClick={() => setDataEntryModalOpen(true)} className="px-5 py-2.5 text-base font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 btn-pulse">新規登録</button>
                    </div>
                  </div>
              </div>
            </header>

            <main className="container mx-auto px-4 sm:px-6 lg:px-8 py-6">
                 <div className="flex justify-center mb-6 bg-gray-200 p-1 rounded-lg">
                    <ViewToggleButton viewName="orders" label="新規自計化" />
                    <ViewToggleButton viewName="migrations" label="クラウド移行" />
                    <ViewToggleButton viewName="cancellations" label="解約" />
                 </div>
                 
                 {/* --- Alerts --- */}
                <div className="space-y-3 mb-6">
                    {validationIssues.crossDuplicates.length > 0 && (
                        <div className="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-md shadow-sm flex justify-between items-center">
                            <p><strong className="font-bold">警告:</strong> 新規自計化とクラウド移行に{validationIssues.crossDuplicates.length}件の重複の可能性があるデータが見つかりました。</p>
                            <button onClick={() => handleShowCorrectionModal('crossDuplicates')} className="ml-4 px-4 py-2 text-sm font-medium rounded-md text-white bg-yellow-600 hover:bg-yellow-700">詳細表示 & 補正</button>
                        </div>
                    )}
                    {validationIssues.orderDuplicates.length > 0 && (
                        <div className="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-md shadow-sm flex justify-between items-center">
                            <p><strong className="font-bold">警告:</strong> 新規自計化に{validationIssues.orderDuplicates.length}件の重複データが見つかりました。</p>
                            <button onClick={() => handleShowCorrectionModal('orderDuplicates')} className="ml-4 px-4 py-2 text-sm font-medium rounded-md text-white bg-yellow-600 hover:bg-yellow-700">詳細表示 & 補正</button>
                        </div>
                    )}
                    {validationIssues.migrationMistakes.length > 0 && (
                        <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md shadow-sm flex justify-between items-center">
                             <p><strong className="font-bold">エラー:</strong> クラウド移行に{validationIssues.migrationMistakes.length}件の登録ミス（変更前がクラウド）の可能性があります。</p>
                            <button onClick={() => handleShowCorrectionModal('migrationMistakes')} className="ml-4 px-4 py-2 text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700">詳細表示 & 補正</button>
                        </div>
                    )}
                     {validationIssues.migrationDuplicates.length > 0 && (
                        <div className="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-md shadow-sm flex justify-between items-center">
                           <p><strong className="font-bold">警告:</strong> クラウド移行に{validationIssues.migrationDuplicates.length}件の重複データが見つかりました。</p>
                            <button onClick={() => handleShowCorrectionModal('migrationDuplicates')} className="ml-4 px-4 py-2 text-sm font-medium rounded-md text-white bg-yellow-600 hover:bg-yellow-700">詳細表示 & 補正</button>
                        </div>
                    )}
                    {validationIssues.cancellationDuplicates.length > 0 && (
                        <div className="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-md shadow-sm flex justify-between items-center">
                           <p><strong className="font-bold">警告:</strong> 解約データに{validationIssues.cancellationDuplicates.length}件の重複データが見つかりました。</p>
                            <button onClick={() => handleShowCorrectionModal('cancellationDuplicates')} className="ml-4 px-4 py-2 text-sm font-medium rounded-md text-white bg-yellow-600 hover:bg-yellow-700">詳細表示 & 補正</button>
                        </div>
                    )}
                </div>

                {isOrdersView && (
                  <div className="relative">
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <EditableSummaryCard title="目標数" value={totalOrderTarget} suffix="件" color="text-blue-500" onSave={handleSaveOrderTarget} />
                        <SummaryCard title="受注数" value={totalActiveOrders} suffix="件" color="text-green-500" subValue={orderCountSubValue} />
                        <SummaryCard title="残り" value={remainingOrders} suffix="件" color="text-orange-500" />
                        <SummaryCard title="達成率" value={orderAchievementRate} suffix="%" color={isOrderTargetAchieved ? "rainbow-text font-extrabold" : "text-indigo-500"} isAchieved={isOrderTargetAchieved} />
                    </div>
                  </div>
                )}
                {isMigrationsView && (
                  <div className="relative">
                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-4 mb-6">
                      <div className="lg:col-span-2"><EditableSummaryCard title="期末累計(目標)" value={migrationTarget} suffix="件" color="text-blue-500" compact={true} onSave={(newValue) => handleUpdateMigrationSetting('target', newValue)} /></div>
                      <div className="lg:col-span-6 bg-gray-50 p-4 rounded-lg border border-dashed flex flex-col">
                           <div className="flex items-center mb-2">
                               <h4 className="text-md font-semibold text-gray-700">当期クラウド純増数</h4>
                               <button onClick={() => setCalcInfoModalOpen(true)} className="ml-2 text-gray-400 hover:text-indigo-600" title="計算ロジックの詳細">
                                  <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                                      <path strokeLinecap="round" strokeLinejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                  </svg>
                               </button>
                           </div>
                          <div className="flex items-stretch justify-around gap-2 flex-grow">
                              <div className="flex-1"><EditableSummaryCard title="期首累計" value={initialCount} suffix="件" color="text-gray-500" compact={true} onSave={(newValue) => handleUpdateMigrationSetting('initialCount', newValue)} /></div>
                              <div className="flex items-center text-2xl font-bold text-gray-400">+</div>
                              <div className="flex-1"><SummaryCard title="当期移行" value={migrationsThisPeriod} suffix="件" color="text-green-500" compact={true} /></div>
                              <div className="flex items-center text-2xl font-bold text-gray-400">+</div>
                              <div className="flex-1"><SummaryCard title="新規受注" value={newCloudOrders} suffix="件" color="text-indigo-500" subValue={newCloudOrdersSubValue} compact={true} /></div>
                              <div className="flex items-center text-2xl font-bold text-gray-400">-</div>
                              <div className="flex-1"><EditableSummaryCard title="解約" value={totalCancellations} suffix="件" color="text-red-500" compact={true} onSave={(newValue) => handleUpdateMigrationSetting('cancellationAdjustment', newValue)} editInitialValue={cancellationAdjustment} subValue={cancellationSubValue} /></div>
                          </div>
                      </div>
                      <div className="lg:col-span-2"><SummaryCard title="残り件数" value={remainingMigrations} suffix="件" color="text-orange-500" compact={true} /></div>
                      <div className="lg:col-span-2"><SummaryCard title="達成率" value={migrationAchievementRate} suffix="%" color={isMigrationTargetAchieved ? "rainbow-text font-extrabold" : "text-purple-500"} isAchieved={isMigrationTargetAchieved} compact={true} /></div>
                    </div>
                  </div>
                )}
                {isCancellationsView && (
                   <div className="relative">
                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-4 mb-6">
                      <div className="lg:col-span-10 lg:col-start-2 bg-gray-50 p-4 rounded-lg border border-dashed">
                          <div className="flex items-stretch justify-around gap-2 h-full">
                              <div className="flex-1"><SummaryCard title="新規受注" value={totalActiveOrders} suffix="件" color="text-green-500" subValue={orderCountSubValue} compact={true} /></div>
                              <div className="flex items-center text-3xl font-bold text-gray-400">-</div>
                              <div className="flex-1"><SummaryCard title="解約件数" value={cancellationsForPeriod.length} suffix="件" color="text-red-500" compact={true} /></div>
                              <div className="flex items-center text-3xl font-bold text-gray-400">=</div>
                              <div className="flex-1"><SummaryCard title="純増社数" value={totalActiveOrders - cancellationsForPeriod.length} suffix="件" color="text-blue-500" compact={true} /></div>
                          </div>
                      </div>
                    </div>
                  </div>
                )}
                
                <div className="mt-4 mb-6 border-b border-gray-300">
                    <nav className="-mb-px flex space-x-6" aria-label="Tabs">
                        <button
                            onClick={() => setActiveSubView('details')}
                            className={`whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm transition-colors ${
                                activeSubView === 'details'
                                    ? 'border-indigo-500 text-indigo-600'
                                    : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                            }`}
                        >
                            詳細データ
                        </button>
                        <button
                            onClick={() => setActiveSubView('analysis')}
                            className={`whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm transition-colors ${
                                activeSubView === 'analysis'
                                    ? 'border-indigo-500 text-indigo-600'
                                    : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                            }`}
                        >
                            分析 (準備中)
                        </button>
                    </nav>
                </div>

                {activeSubView === 'details' && (
                    <DetailsView 
                        items={itemsForPeriod} 
                        offices={uniqueOfficesForPeriod} 
                        systems={uniqueSystemsForPeriod} 
                        onDeleteItem={handleDeleteItem}
                        onToggleTransfer={handleToggleTransfer}
                        viewType={view} 
                    />
                )}
                {activeSubView === 'analysis' && (
                    <div className="bg-white p-12 rounded-lg shadow-md text-center border border-dashed">
                        <svg xmlns="http://www.w3.org/2000/svg" className="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1}>
                            <path strokeLinecap="round" strokeLinejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                        </svg>
                        <h3 className="mt-4 text-xl font-semibold text-gray-700">分析機能は現在準備中です</h3>
                        <p className="mt-2 text-gray-500">今後のアップデートにご期待ください。</p>
                    </div>
                )}
            </main>

            <footer className="text-center py-4 text-gray-500 text-sm">
              <p>&copy; {new Date().getFullYear()} Order Management Tool</p>
            </footer>
          </div>
        );
      };

      // --- Mount Application ---
      const rootElement = document.getElementById('root');
      if (!rootElement) { throw new Error("Could not find root element to mount to"); }
      const root = ReactDOM.createRoot(rootElement);
      root.render(<React.StrictMode><App /></React.StrictMode>);
    </script>
  <script type="module" src="/index.tsx"></script>
</body>
</html>